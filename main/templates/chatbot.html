{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Chatbot" %}{% endblock %}

{% block content %}
<div class="container">
    <h1>{% trans "Chat with our AI" %}</h1>
    <form id="chat-form" method="post" action="{% url 'main:send_user_message' %}">
        {% csrf_token %}
        <div class="mb-3">
            <label for="user_input" class="form-label">{% trans "Your question" %}</label>
            <textarea class="form-control" id="user_input" name="user_input" rows="3"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">{% trans "Ask" %}</button>
    </form>
    <div id="chat-messages" class="mt-4">
        {% for c in conversation reversed %}
            <div class="chat-message">
                <strong>{{ c.user }}:</strong> {{ c.user_input }}
            </div>
            <div class="chat-message">
                <strong>{{ c.ai }}:</strong> {{ c.chatbot_response }}
            </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chat-form');
    const chatMessages = document.getElementById('chat-messages');

    chatForm.addEventListener('submit', async function(event) {
        event.preventDefault();
        const formData = new FormData(chatForm);
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Display user input immediately
        const userInput = formData.get('user_input');
        const userMessageDiv = document.createElement('div');
        userMessageDiv.classList.add('chat-message');
        userMessageDiv.innerHTML = `<strong>You:</strong> ${userInput}`;
        chatMessages.prepend(userMessageDiv);

        try {
            const response = await fetch(chatForm.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                },
                body: formData
            });

            if (!response.ok) {
                throw new Error('Network response was not ok');
            }

            const responseData = await response.json();

            if (responseData.chatbot_response) {
                // Display AI response
                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.classList.add('chat-message');
                aiMessageDiv.innerHTML = `<strong>AI:</strong> ${responseData.chatbot_response}`;
                chatMessages.prepend(aiMessageDiv);
            } else {
                // Handle error scenario
                const errorDiv = document.createElement('div');
                errorDiv.classList.add('chat-message');
                errorDiv.innerHTML = `<strong>Error:</strong> ${responseData.error}`;
                chatMessages.prepend(errorDiv);
            }

            // Clear input field after successful submission
            chatForm.reset();

        } catch (error) {
            console.error('Error:', error);
            // Handle error scenario in UI
            const errorDiv = document.createElement('div');
            errorDiv.classList.add('chat-message');
            errorDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
            chatMessages.prepend(errorDiv);
        }
    });
});
</script>
{% endblock %}
